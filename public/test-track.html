<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TEST Driver Tracking - Phuket Gevalin</title>
    <link rel="stylesheet" href="/css/tailwind.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="bg-gradient-to-br from-orange-50 to-orange-50 min-h-screen">
    <div id="app" class="p-4">
      <!-- Test Environment Badge -->
      <div class="fixed top-4 right-4 z-50">
        <div
          class="bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg font-bold"
        >
          üß™ TEST MODE - STAGING
        </div>
      </div>

      <!-- Loading State -->
      <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
          <i class="fas fa-spinner fa-spin text-4xl text-orange-600 mb-4"></i>
          <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>
      </div>

      <!-- Error State -->
      <div id="error" class="hidden">
        <div class="max-w-md mx-auto mt-20">
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="text-red-600 text-center">
              <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
              <h2 class="text-xl font-semibold mb-2">‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</h2>
              <p id="error-message" class="text-gray-700"></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div id="content" class="hidden max-w-md mx-auto space-y-4 py-4">
        <!-- Header Card -->
        <div
          class="bg-white rounded-xl shadow-lg p-6 border-2 border-orange-200"
        >
          <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold text-gray-900">üß™ TEST Transfer</h1>
            <span
              id="status-badge"
              class="px-3 py-1 rounded-full text-sm font-medium"
            >
              ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô
            </span>
          </div>
          <div class="space-y-2 text-sm">
            <p class="text-gray-500">Booking Ref:</p>
            <p id="booking-ref" class="text-lg font-semibold text-orange-600">
              -
            </p>
          </div>
        </div>

        <!-- Test Info Card -->
        <div class="bg-orange-50 border-2 border-orange-200 rounded-xl p-4">
          <div class="flex items-start gap-3">
            <i class="fas fa-info-circle text-orange-600 text-xl mt-1"></i>
            <div class="flex-1">
              <h3 class="font-semibold text-orange-900 mb-1">üß™ ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
              <p class="text-sm text-orange-800">
                ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏ñ
              </p>
            </div>
          </div>
        </div>

        <!-- Booking Info Card -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-lg font-semibold mb-4 text-gray-900">
            üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
          </h2>
          <div class="space-y-3">
            <div class="flex items-start gap-3">
              <i class="fas fa-user text-orange-600 mt-1"></i>
              <div>
                <p class="text-sm text-gray-500">‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£</p>
                <p id="passenger-name" class="font-medium">-</p>
                <p id="passenger-phone" class="text-sm text-gray-600">-</p>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <i class="fas fa-map-marker-alt text-orange-600 mt-1"></i>
              <div class="flex-1">
                <p class="text-sm text-gray-500">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö</p>
                <p id="pickup-location" class="font-medium">-</p>
                <p id="pickup-datetime" class="text-sm text-orange-600">-</p>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <i class="fas fa-map-marker-alt text-red-600 mt-1"></i>
              <div>
                <p class="text-sm text-gray-500">‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</p>
                <p id="dropoff-location" class="font-medium">-</p>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <i class="fas fa-car text-orange-600"></i>
              <div>
                <p class="text-sm text-gray-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ</p>
                <p id="vehicle-info" class="font-medium">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- GPS Status Card -->
        <div
          id="gps-status"
          class="hidden bg-green-50 border-2 border-green-200 rounded-xl p-4"
        >
          <div class="flex items-center justify-center gap-3 py-2">
            <i
              class="fas fa-satellite-dish text-green-600 text-2xl animate-pulse"
            ></i>
            <h3 class="font-semibold text-green-900 text-lg">
              ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS...
            </h3>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="space-y-4 px-2">
          <!-- Start Button -->
          <button
            id="btn-start"
            class="w-full bg-orange-500 text-white py-8 rounded-2xl font-bold text-3xl shadow-2xl hover:bg-orange-600 active:bg-orange-700 transition-all transform hover:scale-105 active:scale-95"
          >
            <i class="fas fa-play-circle mr-3 text-4xl"></i>
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô
          </button>

          <!-- Before Pickup Buttons (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏£‡∏±‡∏ö) -->
          <div id="before-pickup-buttons" class="hidden space-y-4">
            <button
              id="btn-waiting"
              class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-8 rounded-2xl font-bold text-3xl shadow-2xl hover:from-amber-600 hover:to-orange-600 active:from-amber-700 active:to-orange-700 transition-all transform hover:scale-105 active:scale-95"
            >
              <i class="fas fa-map-marker-alt mr-3 text-4xl"></i>
              ‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
            </button>

            <button
              id="btn-no-show-1"
              class="w-full bg-red-500 text-white py-8 rounded-2xl font-bold text-3xl shadow-2xl hover:bg-red-600 active:bg-red-700 transition-all transform hover:scale-105 active:scale-95"
            >
              <i class="fas fa-user-times mr-3 text-4xl"></i>
              ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (No Show)
            </button>
          </div>

          <!-- Waiting for Customer Buttons (‡∏£‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤) -->
          <div id="waiting-buttons" class="hidden space-y-4">
            <button
              id="btn-after-pickup"
              class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white py-8 rounded-2xl font-bold text-3xl shadow-2xl hover:from-indigo-700 hover:to-blue-700 active:from-indigo-800 active:to-blue-800 transition-all transform hover:scale-105 active:scale-95"
            >
              <i class="fas fa-user-check mr-3 text-4xl"></i>
              ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß
            </button>

            <button
              id="btn-no-show-2"
              class="w-full bg-red-500 text-white py-8 rounded-2xl font-bold text-3xl shadow-2xl hover:bg-red-600 active:bg-red-700 transition-all transform hover:scale-105 active:scale-95"
            >
              <i class="fas fa-user-times mr-3 text-4xl"></i>
              ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (No Show)
            </button>
          </div>

          <!-- After Pickup Buttons (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á) -->
          <div id="after-pickup-buttons" class="hidden space-y-4">
            <button
              id="btn-complete"
              class="w-full bg-green-500 text-white py-8 rounded-2xl font-bold text-3xl shadow-2xl hover:bg-green-600 active:bg-green-700 transition-all transform hover:scale-105 active:scale-95"
            >
              <i class="fas fa-check-circle mr-3 text-4xl"></i>
              ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
            </button>
          </div>

          <!-- Completed State -->
          <div
            id="completed-state"
            class="hidden bg-green-50 border-2 border-green-200 rounded-xl p-6 text-center"
          >
            <i class="fas fa-check-circle text-green-600 text-5xl mb-3"></i>
            <h3 class="text-xl font-semibold text-green-900 mb-2">
              ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!
            </h3>
            <p id="completed-time" class="text-sm text-green-600 mt-2"></p>
          </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-sm text-gray-500 pt-4">
          <p>Phuket Gevalin - TEST Environment</p>
          <p id="expires-at" class="text-xs">-</p>
        </div>
      </div>
    </div>

    <script>
      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      const token =
        urlParams.get("token") || window.location.pathname.split("/").pop();

      let trackingInfo = null;
      let currentStatus = "idle";
      let jobStatus = "BEFORE_PICKUP"; // Track actual job status for Holiday Taxis
      let trackingInterval = null;
      let currentLocation = null;
      let locationSentCount = 0;
      let apiLogs = [];

      // Elements
      const els = {
        loading: document.getElementById("loading"),
        error: document.getElementById("error"),
        errorMessage: document.getElementById("error-message"),
        content: document.getElementById("content"),
        statusBadge: document.getElementById("status-badge"),
        bookingRef: document.getElementById("booking-ref"),
        passengerName: document.getElementById("passenger-name"),
        passengerPhone: document.getElementById("passenger-phone"),
        pickupLocation: document.getElementById("pickup-location"),
        pickupDatetime: document.getElementById("pickup-datetime"),
        dropoffLocation: document.getElementById("dropoff-location"),
        vehicleInfo: document.getElementById("vehicle-info"),
        gpsStatus: document.getElementById("gps-status"),
        btnStart: document.getElementById("btn-start"),
        beforePickupButtons: document.getElementById("before-pickup-buttons"),
        waitingButtons: document.getElementById("waiting-buttons"),
        afterPickupButtons: document.getElementById("after-pickup-buttons"),
        btnWaiting: document.getElementById("btn-waiting"),
        btnAfterPickup: document.getElementById("btn-after-pickup"),
        btnComplete: document.getElementById("btn-complete"),
        btnNoShow1: document.getElementById("btn-no-show-1"),
        btnNoShow2: document.getElementById("btn-no-show-2"),
        completedState: document.getElementById("completed-state"),
        completedTime: document.getElementById("completed-time"),
        expiresAt: document.getElementById("expires-at"),
      };

      // Initialize
      if (!token) {
        showError("‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå");
      } else {
        fetchTrackingInfo();
      }

      async function fetchTrackingInfo() {
        try {
          const response = await fetch(`/api/tracking/info.php?token=${token}`);
          const data = await response.json();

          if (data.success) {
            trackingInfo = data.data;
            renderTrackingInfo();

            if (trackingInfo.status === "active") {
              currentStatus = "tracking";
              startTracking();
            } else if (trackingInfo.status === "completed") {
              currentStatus = "completed";
            }

            updateUI();
          } else {
            showError(data.error || "‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß");
          }
        } catch (err) {
          console.error("Error:", err);
          showError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
        }
      }

      function renderTrackingInfo() {
        els.bookingRef.textContent = trackingInfo.booking_ref;
        els.passengerName.textContent = trackingInfo.booking.passenger_name;
        els.passengerPhone.textContent = trackingInfo.booking.passenger_phone;
        els.pickupLocation.textContent = trackingInfo.booking.pickup_location;
        els.pickupDatetime.textContent = trackingInfo.booking.pickup_datetime;
        els.dropoffLocation.textContent = trackingInfo.booking.dropoff_location;

        const vehicle = trackingInfo.vehicle;
        els.vehicleInfo.textContent = `${vehicle.registration} - ${vehicle.brand} ${vehicle.model}`;

        els.expiresAt.textContent =
          "‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: " +
          new Date(trackingInfo.expires_at).toLocaleString("th-TH");

        // Restore jobStatus from database
        if (trackingInfo.tracking && trackingInfo.tracking.current_job_status) {
          jobStatus = trackingInfo.tracking.current_job_status;
        }

        els.loading.classList.add("hidden");
        els.content.classList.remove("hidden");
      }

      function updateUI() {
        // Hide all button groups first
        els.btnStart.classList.add("hidden");
        els.beforePickupButtons.classList.add("hidden");
        els.waitingButtons.classList.add("hidden");
        els.afterPickupButtons.classList.add("hidden");
        els.completedState.classList.add("hidden");
        els.gpsStatus.classList.add("hidden");

        if (currentStatus === "idle") {
          // Before starting - show start button
          els.statusBadge.textContent = "‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô";
          els.statusBadge.className =
            "px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800";
          els.btnStart.classList.remove("hidden");
        } else if (currentStatus === "tracking") {
          // Show GPS status
          els.gpsStatus.classList.remove("hidden");

          // Show buttons based on jobStatus
          if (jobStatus === "BEFORE_PICKUP") {
            els.statusBadge.textContent = "üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏£‡∏±‡∏ö";
            els.statusBadge.className =
              "px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800 animate-pulse";
            els.beforePickupButtons.classList.remove("hidden");
          } else if (jobStatus === "WAITING_FOR_CUSTOMER") {
            els.statusBadge.textContent = "üü° ‡∏£‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤";
            els.statusBadge.className =
              "px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 animate-pulse";
            els.waitingButtons.classList.remove("hidden");
          } else if (jobStatus === "AFTER_PICKUP") {
            els.statusBadge.textContent = "üîµ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á";
            els.statusBadge.className =
              "px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 animate-pulse";
            els.afterPickupButtons.classList.remove("hidden");
          }
        } else if (currentStatus === "completed") {
          els.statusBadge.textContent = "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
          els.statusBadge.className =
            "px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800";
          els.completedState.classList.remove("hidden");

          const completedDate = new Date();
          els.completedTime.textContent =
            "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: " + completedDate.toLocaleString("th-TH");
        }
      }

      async function startJob() {
        if (!navigator.geolocation) {
          alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
          return;
        }

        try {
          // Get initial location
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              // Start job (TEST MODE - uses staging endpoint)
              const response = await fetch("/api/tracking/test-start.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token }),
              });

              const data = await response.json();

              if (data.success) {
                currentStatus = "tracking";
                jobStatus = "BEFORE_PICKUP";
                locationSentCount = 0;
                updateUI();
                await sendLocationTest(position);
                startTracking();
                alert("‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤");
              } else {
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ: " + data.error);
              }
            },
            (error) => {
              console.error("GPS Error:", error);
              alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á GPS ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        } catch (err) {
          console.error("Start job error:", err);
          alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ");
        }
      }

      function startTracking() {
        sendLocationUpdate();

        if (trackingInterval) clearInterval(trackingInterval);

        // Send location every 5 seconds (as requested by Holiday Taxis)
        trackingInterval = setInterval(() => {
          sendLocationUpdate();
        }, 5 * 1000);
      }

      function sendLocationUpdate() {
        navigator.geolocation.getCurrentPosition(
          (position) => sendLocationTest(position),
          (error) => console.error("GPS Error:", error),
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      }

      async function sendLocationTest(position) {
        const location = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
          accuracy: position.coords.accuracy,
          status: jobStatus, // Send current job status with every location update
        };

        currentLocation = location;
        locationSentCount++;

        try {
          // Send to TEST location endpoint
          const response = await fetch("/api/tracking/test-location.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, ...location }),
          });

          const data = await response.json();
        } catch (err) {
          console.error("Error sending location:", err);
        }
      }

      async function waitingForCustomer() {
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß?")) return;

        jobStatus = "WAITING_FOR_CUSTOMER";
        updateUI();

        // Send location immediately with new status
        sendLocationUpdate();

        alert("‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏£‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' ‡πÅ‡∏•‡πâ‡∏ß");
      }

      async function afterPickup() {
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß?")) return;

        jobStatus = "AFTER_PICKUP";
        updateUI();

        // Send location immediately with new status
        sendLocationUpdate();

        alert("‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á' ‡πÅ‡∏•‡πâ‡∏ß");
      }

      async function completeJob() {
        if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

        if (trackingInterval) clearInterval(trackingInterval);

        try {
          const response = await fetch("/api/tracking/complete.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token,
              status: "COMPLETED",
              notes: "Test completed",
            }),
          });

          const data = await response.json();

          if (data.success) {
            currentStatus = "completed";
            jobStatus = "COMPLETED";
            updateUI();
            alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!");
          } else {
            alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: " + data.error);
          }
        } catch (err) {
          console.error("Complete job error:", err);
          alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ");
        }
      }

      async function noShowJob() {
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏≤ (No Show)?")) return;

        if (trackingInterval) clearInterval(trackingInterval);

        try {
          const response = await fetch("/api/tracking/complete.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token,
              status: "NO_SHOW",
              notes: "Customer no show",
            }),
          });

          const data = await response.json();

          if (data.success) {
            currentStatus = "completed";
            jobStatus = "NO_SHOW";
            updateUI();
            alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å No Show ‡πÅ‡∏•‡πâ‡∏ß!");
          } else {
            alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: " + data.error);
          }
        } catch (err) {
          console.error("No show job error:", err);
          alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ");
        }
      }

      function showError(message) {
        els.loading.classList.add("hidden");
        els.errorMessage.textContent = message;
        els.error.classList.remove("hidden");
      }

      // Event listeners
      els.btnStart.addEventListener("click", startJob);
      els.btnWaiting.addEventListener("click", waitingForCustomer);
      els.btnAfterPickup.addEventListener("click", afterPickup);
      els.btnComplete.addEventListener("click", completeJob);
      els.btnNoShow1.addEventListener("click", noShowJob);
      els.btnNoShow2.addEventListener("click", noShowJob);
    </script>
  </body>
</html>
